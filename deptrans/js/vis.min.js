function render(t){title.text(t);var e=null_data,r=d3.layout.chord().matrix(e);arcs=svg.append("svg:g").attr("class","arc").selectAll("g").data(r.groups).enter().append("svg:g").attr("id",function(t,e){return"arc"+e}),arcs.append("svg:path").on("mouseover",mouseover).style("fill",function(t,e){return Colors[e]}).attr("d",arc),chordlines=svg.append("svg:g").attr("class","chord"),textcircle=svg.append("svg:circle").attr("class","circle"),last_chord=r,last_place=0}function mouseover(t,e){chordlines.classed("fade",function(t){return t.source.index!=e&&t.target.index!=e})}function update(t){if(last_place!=t){var e={},r=[],a=0;"Москва"===t?(title.text(t).on("click",function(){update(t)}),r=data,e=okrugs):(title.text(""),district_title=title.append("text").text("Москва/"+t),file.forEach(function(n){n.okrug===t&&(r.push(n.routes),e[a]=n.district,a++)}));var n=d3.layout.chord().padding(mypadding).sortSubgroups(d3.descending).matrix(r);svg.select(".chord").remove(),arcs.select("text").remove(),textcircle.remove(),arcs=svg.select(".arc").selectAll("g").data(n.groups),arcs.select("path").transition().duration(1e3).delay(0).attrTween("d",arcTween(last_chord)),arcs.select("path").on("mouseover",mouseover),arcs.select("title").text(function(t,r){return 0!=t.value?e[r]:""}),labels=arcs.append("svg:text").attr("class","label").attr("transform",function(t,r){var a=arc.centroid(t),n=a[0],s=a[1],l=Math.sqrt(n*n+s*s);return 1===e[r].split(" ").length?"translate("+n/l*(outerRadius+10)+","+s/l*(outerRadius+15)+")":"translate("+n/l*(outerRadius+10)+","+s/l*(outerRadius+20)+")"}).attr("text-anchor",function(t){return(t.endAngle+t.startAngle)/2>Math.PI?"end":"start"}),labels.text(function(t,r){if(0!=t.value){var a=e[r].split(" ");return a[0]}return""}).style("stroke","#272822").style("fill-opacity",".2"),labels.append("tspan").text(function(t,r){if(0==t.value)return"";var a=e[r].split(" ");return 2===a.length?a[1]:void 0}).attr("x","0em").attr("y","1.1em").style("stroke","#272822").style("fill-opacity",".2"),labels.transition().delay(100).duration(1e3).style("stroke","#f9e8d6").style("fill-opacity","1"),labels.select("tspan").transition().delay(100).duration(1e3).style("stroke","#f9e8d6").style("fill-opacity","1"),chordlines=svg.append("svg:g").attr("class","chord").selectAll("path").data(n.chords).enter().append("svg:path").attr("id",function(t,e){return"chord"+e}).style("fill",function(t){return Colors[t.source.index]}).attr("d",chordl),chordlines.style("fill-opacity",".1").transition().delay(100).duration(1e3).attr("d",chordl).style("fill-opacity",".8"),chordlines.append("title").text(function(t){return e[t.source.index]+" ↔ "+e[t.target.index]+": "+t.source.value}),textcircle=svg.append("svg:circle").attr("class","circle").attr("r",innerRadius),last_chord=n,last_place=t}}function maprender(){d3.json("data/moscowmap.json",function(t,e){var r=270,a=300,n=2200,s=[-110,500],l=d3.geo.mercator().scale(n).center([37,55]).translate(s),i=d3.geo.path().projection(l),d=d3.select("#map").append("svg").attr("width",r).attr("height",a),o=d.append("svg:g").attr("class","okrug").selectAll("path").data(topojson.feature(e,e.objects.okrugs).features).enter().append("svg:path").style("fill",function(t,e){return Colors[e]}).attr("d",i).on("click",function(t){update(t.properties.NAME)}).on("mouseover",function(){d3.select(this).style("stroke","White").style("stroke-width","2px")}).on("mouseout",function(){d3.select(this).style("stroke","#272822").style("stroke-width","1px")});o.append("title").text(function(t){return t.properties.NAME})})}function arcTween(t){return function(e,r){var r=d3.interpolate(t.groups()[r],e);return function(t){return arc(r(t))}}}function chordTween(t){return function(e,r){var r=d3.interpolate(t.chords()[r],e);return function(t){return chordl(r(t))}}}var Colors=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2","#762a83","#af8dc3","#e7d4e8","#d9f0d3","#7fbf7b","#1b7837"],okrugs={0:"СВАО",1:"ВАО",2:"ЦАО",3:"ЮВАО",4:"ЮАО",5:"ЮЗАО",6:"ЗАО",7:"СЗАО",8:"САО",9:"",10:"",11:"",12:"",13:"",14:"",15:"",16:""},file;d3.json("data/matrix.json",function(t){file=t});var data=[[156,8,31,2,0,0,0,0,29,0,0,0,0,0,0,0,0],[8,194,24,36,0,0,0,0,1,0,0,0,0,0,0,0,0],[31,24,151,27,34,22,21,14,26,0,0,0,0,0,0,0,0],[2,36,27,194,30,2,1,1,2,0,0,0,0,0,0,0,0],[0,0,34,30,240,49,7,0,0,0,0,0,0,0,0,0,0],[0,0,22,2,49,184,52,0,1,0,0,0,0,0,0,0,0],[0,0,21,1,7,52,211,12,5,0,0,0,0,0,0,0,0],[0,0,14,1,0,0,12,160,36,0,0,0,0,0,0,0,0],[29,1,26,2,0,1,5,36,183,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],null_data=[[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],last_chord={},last_place,mypadding=.075,width=760,height=600,outerRadius=.37*Math.min(width,height),innerRadius=.935*outerRadius,northAngle=10*Math.PI/180,endAngle=2*Math.PI-mypadding,arc=d3.svg.arc().startAngle(function(t){return isNaN(t.endAngle)&&(t.value=0,t.endAngle=0,t.startAngle=0),t.startAngle<endAngle?t.startAngle:endAngle}).endAngle(function(t){return t.endAngle<=endAngle?t.endAngle:endAngle}).innerRadius(innerRadius).outerRadius(outerRadius),chordl=d3.svg.chord().radius(innerRadius),svg=d3.select("#chart").append("svg:svg").attr("width",width).attr("height",height).append("svg:g").attr("id","chart").attr("transform","translate("+width/2+","+(height/2-20)+")");maprender();var title=d3.select("#title").text("Москва"),district_title,arcs,chordlines,labels,textcircle;render("Москва"),update("Москва"),d3.select("#msk").on("click",function(){render("Москва")}),d3.select("#clear").on("click",function(){title.text(""),svg.select(".arc").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".chord").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".label").transition().duration(50).delay(0).attr("visibility","hidden")});