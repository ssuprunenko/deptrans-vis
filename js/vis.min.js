function render(myplace){title.text(myplace),svg.select(".chord").remove(),svg.select(".arc").remove(),svg.select(".label").remove();var places={},matrix=[],n=0;"Москва"===myplace?(matrix=data,places=okrugs):file.forEach(function(d){d.okrug===myplace&&(matrix.push(d.routes),places[n]=d.district,n++)});var layout=d3.layout.chord().padding(.05).sortSubgroups(d3.ascending).sortChords(d3.ascending).matrix(matrix);arcs=svg.append("svg:g").attr("class","arc").selectAll("g").data(layout.groups).enter().append("svg:g").attr("id",function(d,i){return"arc"+i}),arcs.append("svg:path").on("mouseover",mouseover).style("fill",function(d,i){return Colors[i]}).attr("d",arc),arcs.append("title").text(function(d,i){return 0!=d.value?places[i]:""}),arcs.append("svg:text").attr("class","label").attr("transform",function(d){var c=arc.centroid(d),x=c[0],y=c[1],h=Math.sqrt(x*x+y*y);return"translate("+x/h*(outerRadius+10)+","+y/h*(outerRadius+10)+")"}).attr("dy",".35em").attr("text-anchor",function(d){return(d.endAngle+d.startAngle)/2>Math.PI?"end":"start"}).text(function(d,i){return 0!=d.value?places[i]:""}),chordlines=svg.append("svg:g").attr("class","chord").selectAll("path").data(layout.chords).enter().append("svg:path").attr("id",function(d,i){return"chord"+i}).style("fill",function(d){return Colors[d.source.index]}).attr("d",chordl),chordlines.append("title").text(function(d){return places[d.source.index]+" ↔ "+places[d.target.index]+": "+d.source.value}),textcircle=svg.append("svg:circle").attr("class","circle").attr("r",innerRadius),last_chord=layout,last_place=myplace}function mouseover(d,i){chordlines.classed("fade",function(p){return p.source.index!=i&&p.target.index!=i})}function update(myplace){title.text(myplace);var places={},matrix=[],n=0;file.forEach(function(d){d.okrug===myplace&&(matrix.push(d.routes),places[n]=d.district,n++)});var layout=d3.layout.chord().padding(0).sortSubgroups(d3.descending).sortChords(d3.ascending).matrix(matrix);last_place!=myplace&&(svg.select(".chord").remove(),arcs.select("text").remove(),textcircle.remove(),arcs=svg.select(".arc").selectAll("g").data(layout.groups),arcs.select("path").transition().duration(750).delay(20).attrTween("d",arcTween(last_chord)),arcs.select("path").on("mouseover",mouseover),arcs.select("title").text(function(d,i){return 0!=d.value?places[i]:""}),labels=arcs.append("svg:text").attr("class","label").attr("transform",function(d){var c=arc.centroid(d),x=c[0],y=c[1],h=Math.sqrt(x*x+y*y);return"translate("+x/h*(outerRadius+10)+","+y/h*(outerRadius+17)+")"}).attr("text-anchor",function(d){return(d.endAngle+d.startAngle)/2>Math.PI?"end":"start"}),labels.text(function(d,i){if(0!=d.value){var name=places[i].split(" ");return name[0]}return""}),labels.append("tspan").text(function(d,i){if(0==d.value)return"";var name=places[i].split(" ");return 2===name.length?name[1]:void 0}).attr("x","0em").attr("y","1.1em"),chordlines=svg.append("svg:g").attr("class","chord").selectAll("path").data(layout.chords).enter().append("svg:path").attr("id",function(d,i){return"chord"+i}).style("fill",function(d){return Colors[d.source.index]}).attr("d",chordl),chordlines.append("title").text(function(d){return places[d.source.index]+" ↔ "+places[d.target.index]+": "+d.source.value}),textcircle=svg.append("svg:circle").attr("class","circle").attr("r",innerRadius),last_chord=layout,last_place=myplace)}function maprender(){d3.json("data/moscowmap.json",function(error,msk){var width=270,height=300,scale=2200,offset=[-110,500],projection=d3.geo.mercator().scale(scale).center([37,55]).translate(offset),path=d3.geo.path().projection(projection),svg=d3.select("#map").append("svg").attr("width",width).attr("height",height),okrugsmap=svg.append("svg:g").attr("class","okrug").selectAll("path").data(topojson.feature(msk,msk.objects.okrugs).features).enter().append("svg:path").style("fill",function(d,i){return Colors[i]}).attr("d",path).on("click",function(d){update(d.properties.NAME)}).on("mouseover",function(){d3.select(this).style("stroke","White").style("stroke-width","2px")}).on("mouseout",function(){d3.select(this).style("stroke","Black").style("stroke-width",".5px")});okrugsmap.append("title").text(function(d){return d.properties.NAME})})}function arcTween(last_chord){return function(d,i){var i=d3.interpolate(last_chord.groups()[i],d);return function(t){return arc(i(t))}}}function chordTween(chord){return function(d,i){var i=d3.interpolate(chord.chords()[i],d);return function(t){return chordl(i(t))}}}var Colors=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2","#762a83","#af8dc3","#e7d4e8","#d9f0d3","#7fbf7b","#1b7837"],okrugs={0:"СВАО",1:"ВАО",2:"ЦАО",3:"ЮВАО",4:"ЮАО",5:"ЮЗАО",6:"ЗАО",7:"СЗАО",8:"САО",17:"",17:"",17:"",17:"",17:"",17:"",17:"",17:""},msk_colors={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,17:17},file;d3.json("data/matrix.json",function(myfile){file=myfile});var data=[[156,8,31,2,0,0,0,0,29,0,0,0,0,0,0,0,0],[8,194,24,36,0,0,0,0,1,0,0,0,0,0,0,0,0],[31,24,151,27,34,22,21,14,26,0,0,0,0,0,0,0,0],[2,36,27,194,30,2,1,1,2,0,0,0,0,0,0,0,0],[0,0,34,30,240,49,7,0,0,0,0,0,0,0,0,0,0],[0,0,22,2,49,184,52,0,1,0,0,0,0,0,0,0,0],[0,0,21,1,7,52,211,12,5,0,0,0,0,0,0,0,0],[0,0,14,1,0,0,12,160,36,0,0,0,0,0,0,0,0],[29,1,26,2,0,1,5,36,183,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],last_chord={},last_place,fill=d3.scale.category20c(),width=760,height=600,outerRadius=.38*Math.min(width,height),innerRadius=.91*outerRadius,northAngle=0*Math.PI/180,arc=d3.svg.arc().startAngle(function(d){return 0!=d.value?d.startAngle-northAngle+.005:2*Math.PI}).endAngle(function(d,i){return 0!=d.value&8!=i?(console.log(i),d.endAngle-northAngle-.005):8===i?2*Math.PI-.05:2*Math.PI}).innerRadius(innerRadius).outerRadius(outerRadius),chordl=d3.svg.chord().startAngle(function(d){return d.startAngle-northAngle}).endAngle(function(d){return d.endAngle-northAngle}).radius(innerRadius),svg=d3.select("#chart").append("svg:svg").attr("width",width).attr("height",height).append("svg:g").attr("id","chart").attr("transform","translate("+width/2+","+(height/2-20)+")");maprender();var title=d3.select("#title").text("Москва"),arcs,chordlines,labels,textcircle;render("Москва"),d3.select("#msk").on("click",function(){render("Москва")}),d3.select("#clear").on("click",function(){title.text(""),svg.select(".arc").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".chord").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".label").transition().duration(50).delay(0).attr("visibility","hidden")});