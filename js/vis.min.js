function render(t){title.text(t),svg.select(".chord").remove(),svg.select(".arc").remove(),svg.select(".label").remove();var e={},r=[],n=0;"Москва"===t?(r=data,e=okrugs):file.forEach(function(a){a.okrug===t&&(r.push(a.routes),e[n]=a.district,n++)});var a=d3.layout.chord().padding(mypadding).sortSubgroups(d3.descending).matrix(r);arcs=svg.append("svg:g").attr("class","arc").selectAll("g").data(a.groups).enter().append("svg:g").attr("id",function(t,e){return"arc"+e}),arcs.append("svg:path").on("mouseover",mouseover).style("fill",function(t,e){return Colors[e]}).attr("d",arc),arcs.append("title").text(function(t,r){return 0!=t.value?e[r]:""}),arcs.append("svg:text").attr("class","label").attr("transform",function(t){var e=arc.centroid(t),r=e[0],n=e[1],a=Math.sqrt(r*r+n*n);return"translate("+r/a*(outerRadius+10)+","+n/a*(outerRadius+10)+")"}).attr("dy",".35em").attr("text-anchor",function(t){return(t.endAngle+t.startAngle)/2>Math.PI?"end":"start"}).text(function(t,r){return 0!=t.value?e[r]:""}),chordlines=svg.append("svg:g").attr("class","chord").selectAll("path").data(a.chords).enter().append("svg:path").attr("id",function(t,e){return"chord"+e}).style("fill",function(t){return Colors[t.source.index]}).attr("d",chordl),chordlines.append("title").text(function(t){return e[t.source.index]+" ↔ "+e[t.target.index]+": "+t.source.value}),textcircle=svg.append("svg:circle").attr("class","circle").attr("r",innerRadius),last_chord=a,last_place=t}function mouseover(t,e){chordlines.classed("fade",function(t){return t.source.index!=e&&t.target.index!=e})}function update(t){title.text(t);var e={},r=[],n=0;file.forEach(function(a){a.okrug===t&&(r.push(a.routes),e[n]=a.district,n++)});var a=d3.layout.chord().padding(mypadding).sortSubgroups(d3.descending).matrix(r);last_place!=t&&(svg.select(".chord").remove(),arcs.select("text").remove(),textcircle.remove(),arcs=svg.select(".arc").selectAll("g").data(a.groups),arcs.select("path").transition().duration(750).delay(20).attrTween("d",arcTween(last_chord)),arcs.select("path").on("mouseover",mouseover),arcs.select("title").text(function(t,r){return 0!=t.value?e[r]:""}),labels=arcs.append("svg:text").attr("class","label").attr("transform",function(t){var e=arc.centroid(t),r=e[0],n=e[1],a=Math.sqrt(r*r+n*n);return"translate("+r/a*(outerRadius+10)+","+n/a*(outerRadius+17)+")"}).attr("text-anchor",function(t){return(t.endAngle+t.startAngle)/2>Math.PI?"end":"start"}),labels.text(function(t,r){if(0!=t.value){var n=e[r].split(" ");return n[0]}return""}),labels.append("tspan").text(function(t,r){if(0==t.value)return"";var n=e[r].split(" ");return 2===n.length?n[1]:void 0}).attr("x","0em").attr("y","1.1em"),chordlines=svg.append("svg:g").attr("class","chord").selectAll("path").data(a.chords).enter().append("svg:path").attr("id",function(t,e){return"chord"+e}).style("fill",function(t){return Colors[t.source.index]}).attr("d",chordl),chordlines.append("title").text(function(t){return e[t.source.index]+" ↔ "+e[t.target.index]+": "+t.source.value}),textcircle=svg.append("svg:circle").attr("class","circle").attr("r",innerRadius),last_chord=a,last_place=t)}function maprender(){d3.json("data/moscowmap.json",function(t,e){var r=270,n=300,a=2200,s=[-110,500],d=d3.geo.mercator().scale(a).center([37,55]).translate(s),c=d3.geo.path().projection(d),o=d3.select("#map").append("svg").attr("width",r).attr("height",n),i=o.append("svg:g").attr("class","okrug").selectAll("path").data(topojson.feature(e,e.objects.okrugs).features).enter().append("svg:path").style("fill",function(t,e){return Colors[e]}).attr("d",c).on("click",function(t){update(t.properties.NAME)}).on("mouseover",function(){d3.select(this).style("stroke","White").style("stroke-width","2px")}).on("mouseout",function(){d3.select(this).style("stroke","Black").style("stroke-width",".5px")});i.append("title").text(function(t){return t.properties.NAME})})}function arcTween(t){return function(e,r){var r=d3.interpolate(t.groups()[r],e);return function(t){return arc(r(t))}}}function chordTween(t){return function(e,r){var r=d3.interpolate(t.chords()[r],e);return function(t){return chordl(r(t))}}}var Colors=["#9e0142","#d53e4f","#f46d43","#fdae61","#fee08b","#ffffbf","#e6f598","#abdda4","#66c2a5","#3288bd","#5e4fa2","#762a83","#af8dc3","#e7d4e8","#d9f0d3","#7fbf7b","#1b7837"],okrugs={0:"СВАО",1:"ВАО",2:"ЦАО",3:"ЮВАО",4:"ЮАО",5:"ЮЗАО",6:"ЗАО",7:"СЗАО",8:"САО"},msk_colors={0:0,1:1,2:2,3:3,4:4,5:5,6:6,7:7,8:8,9:9,17:17},file;d3.json("data/matrix.json",function(t){file=t});var data=[[156,8,31,2,0,0,0,0,29,0,0,0,0,0,0,0,0],[8,194,24,36,0,0,0,0,1,0,0,0,0,0,0,0,0],[31,24,151,27,34,22,21,14,26,0,0,0,0,0,0,0,0],[2,36,27,194,30,2,1,1,2,0,0,0,0,0,0,0,0],[0,0,34,30,240,49,7,0,0,0,0,0,0,0,0,0,0],[0,0,22,2,49,184,52,0,1,0,0,0,0,0,0,0,0],[0,0,21,1,7,52,211,12,5,0,0,0,0,0,0,0,0],[0,0,14,1,0,0,12,160,36,0,0,0,0,0,0,0,0],[29,1,26,2,0,1,5,36,183,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]],last_chord={},last_place,mypadding=.075,width=760,height=600,outerRadius=.38*Math.min(width,height),innerRadius=.91*outerRadius,northAngle=10*Math.PI/180,endAngle=2*Math.PI-mypadding,arc=d3.svg.arc().startAngle(function(t){return t.startAngle<endAngle?t.startAngle:endAngle}).endAngle(function(t){return t.endAngle<=endAngle?t.endAngle:endAngle}).innerRadius(innerRadius).outerRadius(outerRadius),chordl=d3.svg.chord().radius(innerRadius),svg=d3.select("#chart").append("svg:svg").attr("width",width).attr("height",height).append("svg:g").attr("id","chart").attr("transform","translate("+width/2+","+(height/2-20)+")");maprender();var title=d3.select("#title").text("Москва"),arcs,chordlines,labels,textcircle;render("Москва"),d3.select("#msk").on("click",function(){render("Москва")}),d3.select("#clear").on("click",function(){title.text(""),svg.select(".arc").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".chord").transition().duration(50).delay(0).attr("visibility","hidden"),svg.select(".label").transition().duration(50).delay(0).attr("visibility","hidden")});